---

- name: "Install Apache."
  community.general.openbsd_pkg:
    name: "{{ item }}"
    state: present
  with_items:
    - apache-httpd
    - apachetop

- name: Enable Apache headers module.
  apache2_module:
    state: present
    name: headers

- name: Copy Apache ServerName to prevent notices.
  ansible.builtin.template:
    src: httpd.conf.j2
    dest: /etc/apache2/conf-available/httpd.conf
    mode: 0644

- name: Copy Apache ports configuration.
  ansible.builtin.template:
    src: ports.conf.j2
    dest: /etc/apache2/ports.conf
    mode: 0644

- name: Check for existing httpd.conf.
  ansible.builtin.stat:
    path: /etc/apache2/conf-enabled/httpd.conf
  register: apache_httpd_conf

- name: Enable Apache httpd configuration file.
  ansible.builtin.command: /usr/sbin/a2enconf httpd
  when: apache_httpd_conf.stat.islnk is not defined

- name: "Install PHP."
  community.general.openbsd_pkg:
    name: "{{ item }}"
    state: present
  with_items:
    - php-apache%8.0
    - pear
    - php-curl%8.0
    - php-gd%8.0
    - pecl80-imagick
    - php-intl%8.0
    - pecl80-mcrypt
    - php-mysqli%8.0
    - php-pgsql%8.0
    - php-sqlite3%8.0
  notify: restart apache2

- name: Check if MariaDB is already installed.
  ansible.builtin.stat:
    path: /etc/init.d/mysql
  register: mariadb_installed

- name: Install MariaDB Server.
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - mariadb-server
    - mariadb-client
    - py3-mysqlclient
  register: mariadb_install_packages

- include: secure-apache.yml
- include: secure-mariadb.yml
- include: hosts.yml
- include: owncloud.yml
